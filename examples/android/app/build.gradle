apply plugin: 'com.android.application'

def libsPath = '/Library/libdigidocpp'

android {
    compileSdkVersion 30
    defaultConfig {
        applicationId "ee.ria.libdigidocpp"
        minSdkVersion 21
        targetSdkVersion 30
        versionCode 1
        versionName "1.0"
        if (System.getenv("BUILD_NUMBER")) {
            versionCode Integer.parseInt(System.getenv("BUILD_NUMBER"))
            versionName "1.0." + System.getenv("BUILD_NUMBER")
        }
        setProperty("archivesBaseName", "libdigidocpp-android-$versionName")
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    compileOptions {
        targetCompatibility JavaVersion.VERSION_1_8
        sourceCompatibility JavaVersion.VERSION_1_8
    }
    sourceSets.main.java.srcDirs += [libsPath + '.androidarm/include']
}

dependencies {
    implementation 'androidx.core:core:1.6.0'
}

task schemaZip(type:Zip) {
    println "Create schema zip"
    from (libsPath + '.androidarm/etc/digidocpp/schema/') {
        include '*'
    }
    destinationDirectory = file('src/main/res/raw/')
    archiveFileName = 'schema.zip'
}

task copyLibs {
    println "Copy jniLibs"
    copy {
        from fileTree(libsPath + '.androidarm') {
            include 'lib/libdigidoc_java.so', 'arm-linux-androideabi/lib/armv7-a/libc++_shared.so'
        }.files
        into 'src/main/jniLibs/armeabi-v7a'
    }
    copy {
        from fileTree(libsPath + '.androidarm64') {
            include 'lib/libdigidoc_java.so', 'aarch64-linux-android/lib/libc++_shared.so'
        }.files
        into 'src/main/jniLibs/arm64-v8a'
    }
    copy {
        from fileTree(libsPath + '.androidx86') {
            include 'lib/libdigidoc_java.so', 'i686-linux-android/lib/libc++_shared.so'
        }.files
        into 'src/main/jniLibs/x86'
    }
    copy {
        from fileTree(libsPath + '.androidx86_64') {
            include 'lib/libdigidoc_java.so', 'x86_64-linux-android/lib64/libc++_shared.so'
        }.files
        into 'src/main/jniLibs/x86_64'
    }
}

preBuild.dependsOn schemaZip, copyLibs
